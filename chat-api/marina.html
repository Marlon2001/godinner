<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <title>MARINA</title>
    </head>
    <body>
        <table id="table">
            <tbody>
                <tr>
                    <textarea cols="30" rows="15" id="mensagens_recebidas" readonly style="resize: none;"></textarea>
                </tr>
                <tr>
                    <th><input type="text" id="mensagem"></th>
                    <th><button id="btn_enviar">Enviar</button></th>                    
                </tr>
            </tbody>
        </table>
        <button id="newchat">iniciar chat</button>

        <script src="http://code.jquery.com/jquery-latest.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
        <script>
            $(document).ready(function(){
                const socket = io.connect("http://localhost:3005");
                // Colocar no banco o id deste batepapo
                const username = "Washington";
                let id = 11;
                let idConversa = 46;

                $("#newchat").click(function(){
                    $("#newchat").attr("disabled", true);
                    // $.ajax({
                    //     url: "http://localhost:3005/suporte/usuario",
                    //     method: "post",
                    //     data: {idConsumidor: id},
                    //     async: true,
                    //     success: function(data){
                    //         console.log(data)
                    //         idConversa = data.sala
                    //         entrarNoChat();
                    //     },
                    //     error: function(data){
                    //         alert("erro");
                    //         console.log(data)
                    //     }
                    // });
                    entrarNoChat();

                    function entrarNoChat(){
                        socket.emit('join', {room: idConversa, username: username});

                        $("#btn_enviar").click(function(){
                            const text = $("#mensagem").val();
                            $("#mensagem").val("");
                            socket.emit('message', {nome: username, message: text, room: idConversa});
                        });

                        socket.on('message', function(data) {
                            console.log(data);
                            $("#mensagens_recebidas").append(data.nome + ": " + data.message +"\n");
                        });

                        socket.on('userjoinedthechat', function(data) {
                            $("#mensagens_recebidas").append(data);
                        });
                    }
                });
                
                // socket.on('suporte-user', (data)=>{
                //   alert("oi");
                // })
            });     

        </script>
    </body>
</html>